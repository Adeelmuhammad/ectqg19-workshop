---
title: 'R: Spatial regression'
author: "Roger Bivand"
date: "Thursday, 5 September 2019, 15:12-15:36"
output:
  pdf_document: default
  html_document:
    keep_md: yes
link-citations: yes
bibliography: rmd.bib
---

### Required current contributed CRAN packages:

I am running R 3.6.1, with recent `update.packages()`.

```{r, echo=TRUE}
needed <- c("sf", "stars", "sp", "classInt", "raster", "colorspace", "RColorBrewer", "ggplot2", "cartography", "tmap", "mapview")
```

### Beijing data set

```{r}
library(HSAR)
library(sp)
data(landSPDF)
data(landprice)
data(Beijingdistricts)
```


```{r}
library(sf)
land_sf <- st_as_sf(landSPDF)
landprice_sf <- merge(land_sf, landprice, by="obs")
(landprice_sf <- landprice_sf[order(landprice_sf$district.id.x),])
```

```{r}
all.equal(landprice_sf$district.id.x, landprice_sf$district.id.y)
```

```{r}
library(spatialreg)
dnb1.5 <- spdep::dnearneigh(landprice_sf, 0, 1500, row.names=as.character(landprice_sf$obs))
dists <- spdep::nbdists(dnb1.5, st_geometry(landprice_sf))
edists <- lapply(dists, function(x) exp((-((x/1000)^2))/(1.5^2)))
ozpo <- spdep::set.ZeroPolicyOption(TRUE)
lw <- spdep::nb2listw(dnb1.5, glist=edists, style="W")
W <- as(lw, "CsparseMatrix")
trs <- trW(W, m=50)
```


```{r}
landprice_sf$fyear <- factor(landprice_sf$year + 2003)
landprice_sf$price <- exp(landprice_sf$lnprice)
landprice_sf$area <- exp(landprice_sf$lnarea)
landprice_sf$Dcbd <- exp(landprice_sf$lndcbd)
landprice_sf$Dsubway <- exp(landprice_sf$dsubway)
landprice_sf$Dpark <- exp(landprice_sf$dpark)
landprice_sf$Dele <- exp(landprice_sf$dele)
landprice_sf$f_district.id <- factor(landprice_sf$district.id.x)
(t1 <- table(table(landprice_sf$f_district.id)))
```

```{r}
t2 <- table(sapply(st_contains(Beijingdistricts_sf, landprice_sf), length))
all.equal(t1, t2)
```


```{r}
Beijingdistricts$id1 <- Beijingdistricts$id+1
all.equal(unique(landprice_sf$district.id.x), Beijingdistricts$id1)
```

```{r}
(Beijingdistricts_sf <- st_as_sf(Beijingdistricts))
```

```{r, warning=FALSE, message=FALSE}
nb_M <- spdep::poly2nb(Beijingdistricts, queen=FALSE, row.names=as.character(Beijingdistricts$id1))
M <- as(spdep::nb2listw(nb_M, style="B"), "CsparseMatrix")
dim(M)
```

